# 第一部分：连接管理

## Tcp Ip连接

![](/assets/屏幕截图 2017-02-21 13:02:28.png)

### TCP的可靠数据管道

TCP 为 HTTP 提供了一条可靠的比特传输管道。从 TCP 连接一端填入的字节会从另一端以原有的顺序、正确地传送出来

![](/assets/屏幕截图 2017-02-21 13:06:52.png)

### TCP流是分段的、由IP分组传送

> （图4.3）TCP 的数据是通过名为IP 分组（或IP 数据报）的小数据块来发送的。这样的话HTTP 就是“HTTP over TCP over IP”这个“协议栈”中的最顶层了。其安全版本 HTTPS 就是在 HTTP 和 TCP 之间插入了一个（称为 TLS 或 SSL 的）密码加密层。（图4.4）HTTP 要传送一条报文时，会以流的形式将报文数据的内容通过一条打开的 TCP 连接按序传输。TCP 收到数据流之后，会将数据流砍成被称作段的小数据块，并将段封装在 IP 分组中，通过因特网进行传输。所有这些工作都是由 TCP/IP 软件来处理的，HTTP 程序员什么都看不到。

![](/assets/屏幕截图 2017-02-21 13:10:19.png)

![](/assets/屏幕截图 2017-02-21 13:15:04.png)

* Tcp是通过**&lt;源IP 地址、源端口号、目的IP 地址、目的端口号&gt;**识别计算机的

### 用TCP套接字编程

> 套接字 API 允许用户创建 TCP 的端点数据结构，将这些端点与远程服务器的 TCP 端点进行连接，并对数据流进行读写。**TCP API 隐藏了所有底层网络协议的握手细节，以及 TCP 数据流与 IP 分组之间的分段和重装细节**。

![](/assets/屏幕截图 2017-02-21 13:28:29.png)

![](/assets/屏幕截图 2017-02-21 13:30:28.png)

### 对 TCP 性能的考虑

![](/assets/屏幕截图 2017-02-21 13:37:07.png)

1. 客户端首先需要根据 URI 确定 Web 服务器的 IP 地址和端口号。如果最近没有对 URI 中的主机名进行访问，通过 DNS 解析系统将 URI 中的主机名转换成一个 IP 地址可能要花费数十秒的时间，幸运的是，大多数 HTTP 客户端都有一个小的 DNS 缓存，用来保存近期所访问站点的 IP 地址。如果已经在本地“缓存”（记录）了 IP 地址，查询就可以立即完成。因为大多数 Web 浏览器浏览的都是少数常用站点，所以通常都可以很快地将主机名解析出来

2. 接下来，客户端会向服务器发送一条 TCP 连接请求，并等待服务器回送一个请求接受应答。每条新的 TCP 连接都会有连接建立时延。这个值通常最多只有一两秒钟，但如果有数百个 HTTP 事务的话，这个值会快速地叠加上去

3. 接下来，客户端会向服务器发送一条 TCP 连接请求，并等待服务器回送一个请求接受应答。每条新的 TCP 连接都会有连接建立时延。这个值通常最多只有一两秒钟，但如果有数百个 HTTP 事务的话，这个值会快速地叠加上去。

4. 然后，Web 服务器会回送 HTTP 响应，这也需要花费时间

### 性能聚焦区域
> 列出了一些会对 HTTP 程序员产生影响的、最常见的 TCP 相关时延，其中包括

* TCP 连接建立握手；
* TCP 慢启动拥塞控制；
* 数据聚集的 Nagle 算法；
* 用于捎带确认的 TCP 延迟确认算法；
* TIME_WAIT 时延和端口耗尽。
#### TCP连接的握手时延，三次握手
> 建立一条新的 TCP 连接时，甚至是在发送任意数据之前，TCP 软件之间会交换一系列的 IP 分组，对连接的有关参数进行沟通（参见图 4-8）。如果连接只用来传送少量数据，这些交换过程就会严重降低 HTTP 的性能。
![](/assets/屏幕截图 2017-02-21 13:55:40.png)